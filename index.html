<html>
<head>
<title>Speed test</title>
<script type="text/javascript">
function upload(s) {
  console.log("Start upload: "+ s);
  var xhr = new XMLHttpRequest();
  var url = "./server/?module=upload";
  var size = s * 1024 * 1024; //s'MB
  var buffer = new ArrayBuffer(size);
  var int8View = new Int8Array(buffer);
  var blob = new Blob([int8View], {type: "application/octet-stream"});
  xhr.upload.addEventListener("progress", uploadProgress, false);
  xhr.onreadystatechange = processUploadRequest; 
  xhr.open('POST', url, true);
  xhr.setRequestHeader("Content-Type", "application/octet-stream");
  xhr.send(blob);
  var startTime = new Date().getTime();
  function uploadProgress(e) {
      if(e.lengthComputable)
          console.log(e.loaded/e.total);
  }
  function processUploadRequest() {
    if(xhr.readyState == 4 && xhr.status == 200) {
      var endTime = new Date().getTime();
      var elapsedTime = endTime - startTime;
      var uploadSpeed = (s*8/(elapsedTime/1000));
      console.log(uploadSpeed);
      createResult("upload", uploadSpeed);
      if (elapsedTime < 8000 && s <= 128)
          upload(s*2);
    }
  }
}
// Creating Dowload Speed Test request to server
function download(s) {
  console.log("Start download: "+s);
  var xhr = new XMLHttpRequest();
  var url = "./server/";
  var params = "module=download&size="
  var size = s * 1024 *1024; // s'MB
  xhr.addEventListener("progress", downloadProgress, false);
  xhr.onreadystatechange = processDownloadRequest;
  xhr.open('GET', url+"?"+params+size, true);
  xhr.send();
  var startTime = new Date().getTime();
  function downloadProgress(e) {
      console.log(e.loaded/size);
  }
  function processDownloadRequest() {
    //msg received 
    if (xhr.readyState == 4 && xhr.status == 200 ){
      var endTime = new Date().getTime();
      var elapsedTime = endTime - startTime; //ms
      var downloadSpeed = (s*8/(elapsedTime/1000));
      console.log(downloadSpeed);
      createResult("download", downloadSpeed);
      console.log(elapsedTime)
      if(elapsedTime < 8000 && s <= 128)
          download(s*2);
    }
  }
}
function createResult(type, num) {
  var newTr = document.createElement("tr");
  var newTh_D = document.createElement("th");
  var newTh_U = document.createElement("th");
  if (type == "download") {
    newTh_D.innerHTML = num;
    newTh_U.innerHTML = ""; 
  }
  else if (type == "upload") {
    newTh_D.innerHTML = "";
    newTh_U.innerHTML = num;  
  }
  else 
    return;
  newTr.appendChild(newTh_D);
  newTr.appendChild(newTh_U);
  document.getElementById('res').appendChild(newTr);
}
</script>
<style>
table, th, td {
    border: 1px solid black;
    border-collapse: collapse;
}
</style>
</head>
<body>
  <div>
    <button type="button" onclick="download(1)"> Download Test </button>
    <button type="button" onclick="upload(1)"> Upload Test </button>
  </div>
  <div style="margin:0px auto;">
    <table id="res" style="width:70%">
      <tr>
        <th> Download (Mbps)</th>
        <th> Upload (Mbps)</th>
      </tr>
    </table>
  </div>
</body>
</html>
